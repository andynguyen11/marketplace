{% extends "postman/base.html" %}

{% load i18n %}
{% load postman_tags %}
{% load staticfiles %}

{% block account_content %}
<div id="pm_messages">
  <div id="message-wrapper">
    <div class="row">
      <div class="container">
        <div class="col-md-12 ps-messages-view-header">
          <a class="pull-left back button button-left" href="{{ next_url }}"><</a>
          <div class="pull-right message-tools">
            {% if thread.sender == user and thread.sender_bookmarked or thread.recipient == user and thread.recipient_bookmarked %}
              {% if pm_messages|length > 1 %}
              <button class="thread-unbookmark button button-left" data-value="{{ thread.thread_id }}" data-url="">
                <img src="{% static "images/star-active.png" %}">
              </button>
              {% else %}
              <button class="message-unbookmark button button-left" data-value="{{ thread.pk }}" data-url="">
                <img src="{% static "images/star-active.png" %}">
              </button>
              {% endif %}
            {% else %}
              {% if pm_messages|length > 1 %}
              <button class="thread-bookmark button button-left" data-value="{{ thread.thread_id }}" data-url="">
                <img src="{% static "images/star-open.png" %}">
              </button>
              {% else %}
              <button class="message-bookmark button button-left" data-value="{{ thread.pk }}" data-url="">
                <img src="{% static "images/star-open.png" %}">
              </button>
              {% endif %}
            {% endif %}
            </div>
            <div class="clearfix"></div>
        </div>
        <div id="contract_container" data-thread="{{ thread.id }}" data-bid="{{ thread.job.id }}" data-nda="{{ thread.nda }}" data-msa="{{ thread.msa }}"></div>
        <div class="col-md-8">
          <div class="panel panel-default">
          <div class="panel-heading">
            <span class="text-skinny">Conversation with</span>
            <span class="text-yellow">{% if thread.sender == user %} {{ thread.recipient.first_name }} {% else %} {{ thread.sender.first_name }} {% endif %}</span>
          </div>
            <div id="reply-wrapper">
              {% if thread.sender == user and thread.sender_archived or thread.recipient == user and thread.recipient_archived %}
              {% else %}
              {% if reply_to_pk %}
              <form action="{% url 'postman:reply' reply_to_pk %}?next={{ next_url|urlencode }}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div id="pm_reply">{{ form.body }}</div>
                {% if thread.project.project_manager == request.user %}
                <div class="pull-left">
                  <input type="file" name="attachments" multiple />
                  <input type="checkbox" id="nda" name="nda" /> Attach an NDA <br />
                  <input type="checkbox" name="document" /> Attach Master Contract
                </div>
                {% endif %}
                <button class="btn btn-yellow pull-right" type="submit">{% trans 'Send Message' %}</button>
                <div class="clearfix"></div>
              </form>{% endif %}
              {% endif %}
            </div>


          <ul id="pm_messages">
            {% for message in pm_messages %}
            <li>
              {% if message.sender == request.user %}
                <img src="{{ message.sender.get_photo }}" class="profile-photo img-circle pull-right" />
                <div class="sent-message pull-right">
                  {{ message.body|linebreaksbr }}
                  {% if message.attachments.all %}
                    <div class="">
                      <strong>Attached Files </strong>
                        <ul>
                        {% for file in message.attachments.all %}
                          <li><a href="{{ file.path }}" download>{{ file.name }}</a></li>
                        {% endfor %}
                        </ul>
                    </div>
                  {% endif %}
                </div>
                <div class="message-date text-muted pull-right">{{ message.sent_at|date:"DATETIME_FORMAT"}}</div>
                <div class="clearfix"></div>
              {% else %}
                <img src="{{ message.sender.get_photo }}" class="profile-photo img-circle pull-left" />
                <div class="received-message pull-left">
                  {{ message.body|linebreaksbr }}
                  {% if message.attachments.all %}
                    <div class="">
                      <strong>Attached Files </strong>
                        <ul>
                        {% for file in message.attachments.all %}
                          <li><a href="{{ file.path }}" download>{{ file.name }}</a></li>
                        {% endfor %}
                        </ul>
                    </div>
                  {% endif %}
                </div>
                <div class="message-date text-muted pull-left">{{ message.sent_at|date:"DATETIME_FORMAT"}}</div>
                <div class="clearfix"></div>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
	<script type="text/javascript" src="{% static 'js/routes/messaging.js' %}"></script>
{% endblock %}